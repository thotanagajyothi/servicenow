name: ServiceNow DevOps Change Automation

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  servicenow-change:
    name: Create ServiceNow Change
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Create and monitor ServiceNow Change
        id: servicenow-change
        uses: ServiceNow/servicenow-devops-change@v6.1.0
        with:
          # ServiceNow instance details
          instance-url: ${{ secrets.SN_INSTANCE_URL }}

          # DevOps integration token from ServiceNow
          devops-integration-token: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}

          # Tool ID of GitHub integration (sys_id)
          tool-id: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}

          # GitHub context
          context-github: ${{ toJSON(github) }}

          # Pipeline job name
          job-name: "Build and Deploy"

          # Change request payload (MUST be valid JSON)
          change-request: |
            {
              "changeCreationTimeOut": 3600,
              "changeStepTimeOut": 1800,
              "pollingInterval": 30,
              "changeRequestDetails": {
                "attributes": {
                  "short_description": "Test description",
                  "priority": "1",
                  "justification": "test justification",
                  "description": "test description",
                  "cab_required": true,
                  "comments": "Change created via GitHub Actions",
                  "work_notes": "Test work notes"
                },
                "setCloseCode": false
              }
            }

      - name: Print Change Number
        run: |
          echo "ServiceNow Change Number: ${{ steps.servicenow-change.outputs.change-request-number }}"
